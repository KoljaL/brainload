<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Brainload Form</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/svg+xml" href="https://dev.rasal.de/brainload/templates/images/brain.png">
    <!-- <link rel="stylesheet" href="pure.css"> -->
    <link rel="stylesheet" href="style.css">
    <!-- <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/grids-responsive-min.css" /> -->
    <script src="js/formtoobj.js"></script>
    <script src="js/md5.js"></script>
</head>

<body>
    <div id=formcontent></div>
    <div class=alert></div>
    <div id=datalink></div>
    <div id=content>
        <form id=ProfilForm>
            <fieldset>
                <legend>Profil</legend>



                <div class="profil_1">
                    <div class="name">
                        <label for="P_Name">Name</label>
                        <input type="text" id="P_Name" name=Name value=ADXS>
                    </div>
                    <div class="password">
                        <label for="P_Password">Passwort</label>
                        <input type="password" id="P_Password" name=Passwort value=ADXS>
                    </div>
                    <div class="freigeben">
                        <label>Daten</label>
                        <input type=checkbox class=hidden id=P_Freigeben name=Freigeben checked>
                        <label class="buttonlabel zyklus" for=P_Freigeben>freigeben</label>
                    </div>
                </div>


                <div class="profil_1">
                    <div class="alter">
                        <label for="P_Alter">Jahrgang</label>
                        <input type="number" id="P_Alter" name=Alter placeholder=1982>
                    </div>
                    <div class="geschlecht">
                        <label for="P_Geschlecht">Geschlecht</label>
                        <select id="P_Geschlecht" name=Geschlecht>
                            <option disabled selected hidden></option>
                            <option>divers</option>
                            <option>weiblich</option>
                            <option>m√§nnlich</option>
                            <option>keine Angabe</option>
                        </select>
                    </div>
                    <div class="zyklus">
                        <label>Zyklus</label>
                        <input type=checkbox class=hidden id=P_Zyklus name=Zyklus>
                        <label class="buttonlabel zyklus" for=P_Zyklus>abfragen</label>
                    </div>
                </div>


                <div class="profil_2">
                    <div class="subtyp">
                        <label for="P_Subtyp">ADHS-Subtyp</label>
                        <select id="P_Subtyp" name=Subtyp>
                        <option disabled selected hidden></option>
                        <option>ADHS</option>
                        <option>ADS</option>
                        <option>Mischtyp</option>
                        <option>keine Angabe</option>
                    </select>
                    </div>
                    <div class="diagnosen">
                        <label for="P_Diagnosen">weitere Diagnosen</label>
                        <input type="text" id="P_Diagnosen" name=Diagnosen>
                    </div>
                </div>
                <label class="" for=situation>Wirkungen abfragen: </label>
                <div id=WirkungCheckboxes>
                    <input type=checkbox class=hidden id=$value1 name=wirkung[0] value=Unruhe>
                    <label class="buttonlabel wirkung" for=$value1>Unruhe</label>
                    <input type=checkbox class=hidden id=$value2 name=wirkung[1] value=Konzentration>
                    <label class="buttonlabel wirkung" for=$value2>Konzentration</label>
                    <input type=checkbox class=hidden id=$value3 name=wirkung[2] value=Aufmerksamkeit>
                    <label class="buttonlabel wirkung" for=$value3>Aufmerksamkeit</label>
                    <input type=checkbox class=hidden id=$value4 name=wirkung[3] value=Motivation>
                    <label class="buttonlabel wirkung" for=$value4>Motivation</label>
                    <input type=checkbox class=hidden id=$value5 name=wirkung[4] value=Auslastung>
                    <label class="buttonlabel wirkung" for=$value5>Auslastung</label>
                    <input type=text class=newSituation name=wirkung[] placeholder='new situation'>
                </div>
                <div class="kommentar profil">
                    <label class="itemLabel comment" for=P_Kommentar>Kommentar: </label>
                    <textarea name="P_Kommentar" id="P_Kommentar"></textarea>
                </div>
                <br>
                <button type="submit" id=validate>Absenden</button>
            </fieldset>
        </form>


        <form id=MoodForm>
            <fieldset>
                <legend>How do you feel?</legend>

                <div id=Medikation_0>
                    <div class="medikation">
                        <div class="medikament">
                            <label for="M_Medikament[0]">Medikament</label>
                            <select id="M_Medikament[0]" name=Medikation[0][Medikament]>
                                <option disabled selected hidden></option>
                                <option>Attentin</option>
                                <option>Elvanse</option>
                                <option>Elvanse Adult</option>
                                <option>Ritalin (unretardiert)</option>
                                <option>  Medikinet (unretardiert)</option>
                                <option>Ritalin Retard</option>
                                <option>Medikinet Retard</option>
                                <option>Equasym</option>
                                <option>Ritalin Adult</option>
                                <option>Medikinet Adult</option>
                                <option>Kinecteen</option>
                                <option>Concerta</option>
                                <option>Strattera</option>
                                <option>Intuniv </option> 
                            </select>
                        </div>
                        <div class="dosierung">
                            <label for="M_Dosierung[0]">Dosierung</label>
                            <select id="M_Dosierung[0]" name=Medikation[0][Dosierung]>
                                <option disabled selected hidden></option>
                                <option>2.5 mg</option>
                                <option>5 mg</option>
                                <option>10 mg</option>
                                <option>20 mg</option>
                                <option>30 mg</option>
                                <option>40 mg</option>
                                <option>50 mg</option>
                                <option>60 mg</option>
                                <option>70 mg</option>
                                <option>80 mg</option>
                            </select>
                        </div>
                        <div class="zeitpunkt">
                            <label for="M_Zeitpunkt[0]">Zeit</label>
                            <input type="time" id="M_Zeitpunkt[0]" name=Medikation[0][Zeitpunkt]>
                        </div>

                    </div>


                    <details>
                        <summary class=SpoilerMedikation>weitere Angaben</summary>
                        <div class=medikation>
                            <div class="seitwann">
                                <label for="M_SeitWann[0]">seit wann</label>
                                <input type="date" id="M_SeitWann[0]" name=Medikation[0][SeitWann]>
                            </div>

                            <div class="wirkzeit">
                                <label>&nbsp;</label>
                                <input type=checkbox class=hidden id=P_Wirkzeit name=Medikation[0][Wirkzeit]>
                                <label class="buttonlabel wirkzeit" for=P_Wirkzeit>innerhalb der Wirkzeit</label>
                            </div>


                        </div>
                        <div class="kommentar medikament">
                            <label class="itemLabel comment" for=M_Kommentar[0]>Anmerkungen: </label>
                            <textarea id="M_Kommentar[0]" name=Medikation[0][Kommentar]></textarea>
                        </div>
                    </details>



                </div>
                <div id=AddRemoveMedikation class="">
                    <label id=AddMedikation class='plusminus plus' onclick=newMedikation()></label>
                    <label id=RemoveMedikation class='plusminus minus' onclick=delMedikation()></label>
                </div>

                <!-- SITUATIONS -->
                <div id=SituationCheckboxes>
                    <label class="itemLabel situation" for=situation>Situation: </label>
                    <input type=checkbox class=hidden id=$value11 name=[situations][0] value=Zuhause>
                    <label class="buttonlabel situation" for=$value11>Zuhause</label>
                    <input type=checkbox class=hidden id=$value21 name=situations[1] value=Arbeit>
                    <label class="buttonlabel situation" for=$value21>Arbeit</label>
                    <input type=checkbox class=hidden id=$value31 name=situations[2] value=Park>
                    <label class="buttonlabel situation" for=$value31>Park</label>
                    <input type=checkbox class=hidden id=$value41 name=situations[3] value=Klo>
                    <label class="buttonlabel situation" for=$value41>Klo</label>
                    <input type=checkbox class=hidden id=$value51 name=situations[4] value=Bett>
                    <label class="buttonlabel situation" for=$value51>Bett</label>
                    <input type=text class=newSituation name=situations[] placeholder='new situation'>
                </div>
                <div class="MoodSlider">
                    <label class="itemLabel brainload" for=brainloadSlider>Brainload: </label>
                    <div class=sliderValue id=brainloadSliderOutput></div>
                    <input type="range" min="0" max="100" value="0" step="10" class="slider brainload" id=brainloadSlider name=brainload>
                    <label class="itemLabel mood" for=moodSlider>Mood: </label>
                    <div class=sliderValue id=moodSliderOutput></div>
                    <input type="range" min="0" max="100" value="0" step="10" class="slider mood" id=moodSlider name=mood>
                    <label class="itemLabel motivation" for=motivationSlider>Motivation: </label>
                    <div class=sliderValue id=motivationSliderOutput></div>
                    <input type="range" min="0" max="100" value="0" step="10" class="slider motivation" id=motivationSlider name=motivation>
                </div>
                <div class="kommentar mood">
                    <label class="itemLabel comment" for=comment>Comment: </label>
                    <textarea name="comment" id="comment"></textarea>
                </div>
                <br>
                <br>
                <button type="submit" id=validate class="pure-button pure-button-primary">absenden</button>
            </fieldset>
        </form>
    </div>
    <script></script>
</body>
<script>
    //
    // user verification & data link
    //
    var localDataNameField = document.getElementById('P_Name');
    var localDataName = md5(localDataNameField.value);
    var datalink = document.getElementById('datalink');
    datalink.innerHTML = "<a href='save.php?n="+localDataName+"'>JSON<a/>";

    localDataNameField.addEventListener("input", event => {
        localDataName = md5(localDataNameField.value);
        datalink.innerHTML = "<a href='save.php?n="+localDataName+"'>JSON<a/>";
        console.log(localDataName)

    });




    //
    // get POST from forms
    //
    var forms = document.getElementsByTagName("FORM");
    // console.log(forms)
    for (const form of forms) {
        form.addEventListener("submit", function(evt) {
            evt.preventDefault();

            var FormResultsObject = formToObject(document.getElementById(form.id));
            if (FormResultsObject) {
                // FormResultsObject = Object.assign({Timestamp: Date.now()}, FormResultsObject);
                // FormResultsObject = Object.assign({DateISO: new Date()}, FormResultsObject);
                FormResultsObject = Object.assign({
                    Date: new Date().toLocaleDateString()
                }, FormResultsObject);
                // console.log(FormResultsObject)

                //
                // Put the object into storage
                //
                // PROFIL
                if ('ProfilForm' == form.id) {
                    // console.log(FormResultsObject)
                    var localData = JSON.parse(localStorage.getItem(localDataName)) || [];
                    // console.log(localData[0])
                    if (((localData[0]) && localData[0].hasOwnProperty('Profil'))) {
                        localData[0].Profil = FormResultsObject;
                    } else {
                        localData.push({
                            Profil: FormResultsObject
                        });
                    }
                    localStorage.setItem(localDataName, JSON.stringify(localData));
                }
                // MOOD
                if ('MoodForm' == form.id) {
                    // FormResultsObject = {
                    //     Mood: FormResultsObject
                    // };
                    // console.log(FormResultsObject)
                    var localData = JSON.parse(localStorage.getItem(localDataName)) || [];
                    // console.log(localData)
                    localData.push({
                        Mood: FormResultsObject
                    });
                    localStorage.setItem(localDataName, JSON.stringify(localData));
                }
                saveOnServer(localData, localDataName);
            }

            //
            // get FormData in 2D for validation and HTML Output
            //
            let FormData2D = getFormData(form);
            outputFormHTML(FormData2D);
        });
    }

    function saveOnServer(data, localDataName) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "save.php?n=" + localDataName);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                console.log(xhr.responseText);
            }
        }
        xhr.setRequestHeader("Content-type", "application/json")
        xhr.send(JSON.stringify(data));
    }


    //
    // print the FormData on Website
    //
    function outputFormHTML(FormData2D) {
        // write to HTML
        var formContent = '<table>';
        for (const el of FormData2D) {
            formContent += "<tr><td>" + el.name + " </td><td> " + el.value + "</td></tr>";
        }
        formContent += '</table>';
        document.getElementById("formcontent").innerHTML = formContent;
    }

    //
    // get an iterable array from form data 
    // parameter: form.id
    //
    function getFormData(form) {
        var FormData = [];
        Array.prototype.slice.call(form.elements).forEach(function(field) {
            if (!field.name || field.disabled || ['file', 'reset', 'submit', 'button'].indexOf(field.type) > -1) return;
            if (field.type === 'select-multiple') {
                Array.prototype.slice.call(field.options).forEach(function(option) {
                    if (!option.selected) return;
                    FormData.push({
                        name: field.name,
                        value: option.value
                    });
                });
                return;
            }
            if (['checkbox', 'radio'].indexOf(field.type) > -1 && !field.checked) return;
            if (!field.value) return;
            FormData.push({
                name: field.name,
                value: field.value
            });
        });
        // console.log(FormData);
        return FormData;
    }




    /**
     * This function displays a message
     * on the page for 1 second
     *
     * @param {String} message
     */
    // const alertBox = document.querySelector(".alert"); // select alert display div
    // const displayAlert = message => {
    //     alertBox.innerText = message; // add the message into the alert box
    //     alertBox.style.display = "block"; // make the alert box visible
    //     setTimeout(function() {
    //         alertBox.style.display = "none"; // hide the alert box after 1 second
    //     }, 1000);
    // };
    // const message = "Form draft has been saved!";
    // displayAlert(message);



    //
    // add or delete medikations
    //
    var ct = 1;

    function newMedikation() {
        var new_medikation = document.createElement("div");
        new_medikation.className = 'pure-g';
        new_medikation.id = "Medikation_" + ct;
        new_medikation.innerHTML = document.getElementById("Medikation_0").innerHTML.replaceAll('[0]', '[' + ct + ']');
        document.getElementById("AddRemoveMedikation").before(new_medikation);
        document.getElementById("RemoveMedikation").style.display = 'inline';
        ct++;
    }

    function delMedikation() {
        var delMedikation = document.querySelectorAll('[id^=Medikation_]');
        if (delMedikation.length > 1) {
            delMedikation[delMedikation.length - 1].remove();
        }
        if (delMedikation.length == 2) {
            document.getElementById("RemoveMedikation").style.display = 'none';
        }
    }
</script>












<!-- 







// FormResultsObject = Object.assign({
//         Profil: FormResultsObject
//     }, FormResultsObject);


// console.log(currentProfil.Profil)

// localData.push(FormResultsObject);
// var localData = Object.assign({}, localDataA);
// console.log(localData)

// FormResultsObject = {
//     Profil: FormResultsObject
// };






function allLocalStorage() {
    var values = '',
        keys = Object.keys(localStorage),
        i = keys.length;

    while (i--) {
        // console.log(keys[i]);
        // console.log(JSON.stringify(keys[i]).length);
        // console.log(localStorage.getItem(keys[i]));
        values += keys[i] + " Length: " + JSON.stringify(keys[i]).length + "<br>";
    }
    var CURRENTstorageSize = Math.round(JSON.stringify(localStorage).length / 1024);
    for (var i = 0, data = "m"; i < 40; i++) {
        try {
            localStorage.setItem("DATA", data);
            data = data + data;
        } catch (e) {
            var MAXstorageSize = Math.round(JSON.stringify(localStorage).length / 1024);
            // console.log("LIMIT REACHED: (" + i + ") " + MAXstorageSize + "K");
            // console.log(JSON.stringify(localStorage).length)
            // console.log(e);
            var div = document.createElement('div');
            div.innerHTML += 'Files:<br> ' + values + '<br>';
            // div.innerHTML += e + "<br><br>";
            div.innerHTML += 'Max LocalStorage Size: <b>' + MAXstorageSize + '</b>K<br>';
            div.id = "storageSize";
            div.style.color = "#000";
            div.style.background = "#ccc";
            div.style.border = "4px solid #000";
            div.style.borderRadius = "14px";
            div.style.width = "max-content";
            div.style.height = "max-content";
            div.style.padding = "1em";
            div.style.position = "fixed";
            div.style.top = "20px";
            div.style.left = "20px";
            document.body.appendChild(div);
            localStorage.removeItem("DATA");
            break;
        }
    }
}







// var showmore = document.getElementById("showmore");
// var showless = document.getElementById("showless");

// showmore.addEventListener("click", function(evt) {
//     document.getElementById("more").style.display = 'inline';
//     document.getElementById("showmore").style.display = 'none';
// });
// showless.addEventListener("click", function(evt) {
//     document.getElementById("more").style.display = 'none';
//     document.getElementById("showmore").style.display = 'inline';
// }); 







<form id=MedikationForm>
            <fieldset>
                <legend>Medikation</legend>

                <div id=Medikation_0>
                    <div class="medikation">
                        <div class="medikament">
                            <label for="M_Medikament">Medikament</label>
                            <select id="M_Medikament" name=Medikation[0][Medikament]>
                                <option disabled selected hidden></option>
                                <option>Elvanse</option>
                                <option>Ritalin </option>
                                <option>Strattera</option>
                            </select>
                        </div>
                        <div class="dosierung">
                            <label for="M_Dosierung">Dosierung</label>
                            <select id="M_Dosierung" name=Medikation[0][Dosierung]>
                                <option disabled selected hidden></option>
                                <option>2.5 mg</option>
                                <option>5 mg</option>
                                <option>10 mg</option>
                                <option>20 mg</option>
                                <option>30 mg</option>
                                <option>40 mg</option>
                            </select>
                        </div>
                        <div class="zeitpunkt">
                            <label for="M_Zeitpunkt">Zeit</label>
                            <input type="time" id="M_Zeitpunkt" name=Medikation[0][Zeitpunkt]>
                        </div>

                    </div>
                </div>
                <div id=addMedikation class="">
                    <label class='plusminus plus' onclick=newMedikation()></label>
                    <label class='plusminus minus' onclick=delMedikation()></label>
                </div>
                <br>
                <button type="submit" id=validate class="pure-button pure-button-primary">Absenden</button>
            </fieldset>
        </form> -->

</html>